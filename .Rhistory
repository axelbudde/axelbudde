setwd("~/Documents/GitHub/axelbudde")
setwd("~/Documents/IMMUNEBRIDGE")
setwd("~/Documents/IMMUNEBRIDGE")
library(tidyverse)
library(lubridate)
library(parallel)
library(furrr)
library(anytime)
library(tictoc)
vacc_years <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("vacc") &
(ends_with("year")))
setwd("~/Documents/IMMUNEBRIDGE")
library(tidyverse)
library(lubridate)
library(parallel)
library(furrr)
library(anytime)
library(tictoc)
vacc_years <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("vacc") &
(ends_with("year")))
data(immunebridge_preliminary_prefinal_v2.rds)
df_immunebridge_preliminary_prefinal_v2 <- readRDS("~/Documents/IMMUNEBRIDGE/df_immunebridge_preliminary_prefinal_v2.rds")
vacc_years <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("vacc") &
(ends_with("year")))
vacc_months <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("vacc") &
(ends_with("month")))
pcr_years <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("PCR_test_pos_year"))
pcr_months <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("PCR_test_pos_month"))
n_ab_past_years <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("IgG_N_past") &
ends_with("year"))
n_ab_past_months <- df_immunebridge_preliminary_prefinal_v2 %>%
select(starts_with("IgG_N_past") &
ends_with("month"))
current_timepoint <- df_immunebridge_preliminary_prefinal_v2 %>%
mutate(
current_timepoint =
paste(
current_sampling_year,
current_sampling_month,
sep = "-"
) %>%
anydate()) %>%
as.data.frame() %>%
select(current_timepoint)
# Set a "plan" for how the code should run.
plan(multisession,
workers = detectCores() - 1
)
tic()
vacc_timepoints <- map2(
vacc_years,
vacc_months,
paste,
sep = "-"
) %>%
future_map(
.,
anydate,
.progress = TRUE
) %>%
set_names(paste0("vacc_timepoint_", seq_along(1:length(.)))) %>%
as.data.frame()
pcr_timepoints <- map2(
pcr_years,
pcr_months,
paste,
sep = "-"
) %>%
future_map(
.,
anydate,
.progress = TRUE
) %>%
set_names(paste0("pcr_timepoint_", seq_along(1:length(.)))) %>%
as.data.frame()
plan(sequential)
toc()
# Set a "plan" for how the code should run.
plan(multisession,
workers = detectCores() - 1
)
tic()
n_ab_past_timepoints <- map2(
n_ab_past_years,
n_ab_past_months,
paste,
sep = "-"
) %>%
future_map(
.,
anydate,
.progress = TRUE
) %>%
set_names(paste0("n_ab_past_timepoint_", seq_along(1:length(.)))) %>%
as.data.frame()
plan(sequential)
toc()
timepoints <- cbind(
vacc_timepoints,
pcr_timepoints,
n_ab_past_timepoints,
current_timepoint
)
immunebridge <- cbind(
df_immunebridge_preliminary_prefinal_v2,
timepoints
)
styler:::style_active_file()
existing_cohorts <- immunebridge %>%
filter(
case_when(
vacc_count > 0 ~
vacc_count > 2 &
(pcr_timepoint_1 > (vacc_timepoint_2)) &
(dataset == "STAAB" |
dataset == "nako" |
dataset == "MUSPAD (Magdeburg)" |
dataset == "MUSPAD (Hannover)" |
dataset == "MUSPAD (Aachen)") &
PCR_test_number_pos > 0 &
!is.na(pcr_timepoint_1),
TRUE ~
(dataset == "STAAB" |
dataset == "nako" |
dataset == "MUSPAD (Magdeburg)" |
dataset == "MUSPAD (Hannover)" |
dataset == "MUSPAD (Aachen)") &
PCR_test_number_pos > 0 &
!is.na(pcr_timepoint_1)
)
) %>%
mutate(
n_ab = case_when(
IgG_N_quantitative > 1 ~ "Anti-N Positive",
TRUE ~ "Anti-N Negative"
) %>%
as.factor(),
value = 1,
name = "Cut-Off Index",
pcr_year_1 = year(pcr_timepoint_1)
) %>%
mutate(
months_since_vacc_pcr_pos = case_when(
n_ab == "positive" ~ round(as.numeric(difftime(pcr_timepoint_1, vacc_timepoint_1, units = "days")) / (365.25 / 12))
)
) %>%
mutate(months_since_pcr_pos = round(as.numeric(difftime(current_timepoint, pcr_timepoint_1, units = "days")) / (365.25 / 12)) + 1) %>%
mutate(
vacc_status = case_when(
vacc_count > 0 ~ "Vaccinated",
TRUE ~ "Not vaccinated"
),
quantile = case_when(
months_since_pcr_pos <= median(months_since_pcr_pos) ~ "<= 4 Months",
TRUE ~ "> 4 Months"
) %>%
as.factor()
) %>%
as.data.frame()
View(existing_cohorts)
setwd("~/Documents/axelbudde")
setwd("~/Documents/axelbudde")
